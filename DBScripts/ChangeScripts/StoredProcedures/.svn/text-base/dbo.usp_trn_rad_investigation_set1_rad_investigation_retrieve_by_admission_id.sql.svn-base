
IF OBJECT_ID('[dbo].[usp_trn_rad_investigation_set1_rad_investigation_retrieve_by_admission_id]') IS NOT NULL
	DROP PROCEDURE [dbo].[usp_trn_rad_investigation_set1_rad_investigation_retrieve_by_admission_id]
GO  
  
CREATE  PROCEDURE [usp_trn_rad_investigation_set1_rad_investigation_retrieve_by_admission_id]  
 @admissionid char(12)   
    
AS  
/************************************************************************************************  
* Revision History  
*  
* Name: usp_trn_rad_investigation_set1_rad_investigation_retrieve_by_admission_id  
* Description: Retrieve radiology investigation set1 record by admission id  
*  
* Date:    Author:  Ref#:  Comments:             
* 11/24/09 SNgo  N/A      Created.  
*  
**************************************************************************************************/  
  
SET NOCOUNT ON  
  
--DECLARE  @RadiologyInvestigation_ID INT  
  
--SELECT   @RadiologyInvestigation_ID = RadiologyInvestigation_ID     
--FROM   [dbo].trn_RadiologyInvestigation     
--WHERE   admission_id = @admissionid  
  
  
SET NOCOUNT OFF;  
  
  
DECLARE  @temp  TABLE(  RowId   INT NOT NULL IDENTITY(1,1)  
      ,Reference_Code_Description  VARCHAR(1030)  
      )  
  
INSERT @temp(Reference_Code_Description)  
SELECT RTRIM(procedure_code_ref_code) + ' - ' + RTRIM(procedure_code_description) + '$'           
FROM   (
SELECT a.id AS radinvestigationset1_id,      
  --a.rad_investigation_date AS rad_investigation_date,      
  a.procedure_code_id AS procedure_code_id,      
  b.reference_code AS procedure_code_ref_code,      
  b.description AS procedure_code_description,      
  a.clinical_code_id AS clinical_code_id,      
  c.reference_code AS clinical_code_ref_code,      
  c.description as clinical_code_description,    
  d.service_type as procedure_service_type,  
  a.anaesthesia_type as anaesthesia_type,  
  --a.facility as facility,  
  --a.anaesthetist_doctor_id AS anaesthetist_doctor_id,     
  b.service_type_id  
 FROM [dbo].trn_Procedure a INNER JOIN      
   [dbo].Procedure_Code b ON a.procedure_code_id = b.procedure_code_id LEFT OUTER JOIN      
   [dbo].Procedure_Code c ON a.clinical_code_id = c.procedure_code_id  INNER JOIN  
   [dbo].Procedure_Code_Service_Type d ON b.service_type_id = d.id 
 WHERE a.admission_id=@admissionid and d.id=3
) a
--WHERE  service_type_id = 3  --Service type of Radiology based from Procedure_Code_Service_Type table  

 
  
DECLARE  @RowId INT  
DECLARE  @Code_Description VARCHAR(1030)  
  
DECLARE  @RetValue VARCHAR(5000)  
SET @RowId = 1  
SET @RetValue = ''  
WHILE EXISTS(SELECT * FROM @temp WHERE  RowId= @RowId)  
BEGIN  
 SELECT @Code_Description = Reference_Code_Description    
 FROM @temp  
 WHERE RowId = @RowId  
 SET @RetValue =@RetValue + @Code_Description  
 SET @Code_Description= ''  
 SET @RowId = @RowId +1  
END  
  
  
SELECT @RetValue AS 'codedescription'  
SET NOCOUNT ON;  



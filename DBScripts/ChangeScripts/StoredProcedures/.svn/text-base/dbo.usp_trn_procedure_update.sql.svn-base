IF OBJECT_ID ('usp_trn_procedure_update') IS NOT NULL
	DROP PROCEDURE [dbo].usp_trn_procedure_update
GO

CREATE PROCEDURE [dbo].usp_trn_procedure_update
(
	 @id int
	,@procedure_date datetime
	,@procedure_code_id int
	,@clinical_code_id int	
	,@doctor_id char(12)
	,@anaesthesia_type tinyint
	,@procedure_facility text
	,@anaesthetist_id char(12)
	,@procedure_type tinyint
	,@username varchar(20)
)
AS
/*********************************************************************************
*	Revision History
*
*	Name: usp_trn_procedure_update
*	Description: Updates a record in the trn_Procedure table
*
*	Date:		Author:		Ref#:		Comments:
*	11/03/10	EBrosas		7429		Change SP call from usp_audit_logging to usp_audit_logging_new.
*	09/20/10	MLim		7424		Created
*
**********************************************************************************/

DECLARE @date datetime,
		@claim_id varchar(12)

SET @date = (SELECT GETDATE())

SELECT @claim_id = claim_id 
FROM dbo.Admission a 
	LEFT JOIN dbo.trn_Procedure b ON b.admission_id = a.admission_id
WHERE b.id = @id

UPDATE
	[dbo].trn_Procedure
SET
	 procedure_date = @procedure_date
	,procedure_code_id = @procedure_code_id
	,clinical_code_id = @clinical_code_id
	,doctor_id = @doctor_id
	,anaesthesia_type = @anaesthesia_type
	,procedure_facility = @procedure_facility
	,anaesthetist_id = @anaesthetist_id
	,procedure_type = @procedure_type
	,update_user = @username
	,update_date = @date
WHERE
	id = @id

EXEC usp_audit_logging_new @id, @claim_id, 'trn_Procedure', 'Update', @date, @username, 'CF_Clinical'    
--EXEC usp_audit_logging @id, @id, 'trn_Procedure', 'Update', @date, @username

GO